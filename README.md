# Multiprocessing of Parameter Estimation for Tsky Model using Markov Chain Monte Carlo - Metropolis-Hastings

![Scheme](https://img.shields.io/badge/v1-mcmc-green) ![Scheme](https://img.shields.io/badge/python-3-yellowgreen)


---




## Quick summary: ##

* This project includes the parallelization of the **Markov Chain Monte Carlo - Metropolis** algorithm.

* This project also includes multiprocessing by using MPI4PY python package.


    -   Version: 1.1
    -   Author: Jorge Cárdenas
   -   [Share this repo](https://bitbucket.org/jcardenas0/mcmc_multiprocessing/)

## Content ##
```
root
│   README.md
│   requirements.txt
│   mc_estimator.py
│   figure1_plotdata.csv
│   DataAnalysis.ipynb
└───mc_sim
       │   imports.py
       │   MCMC.py
       │   models.py
       │   multiproc.py
```

| file                	| Description                                                            	|
|-----------------------	|------------------------------------------------------------------------	|
| requirements.txt             	| List of installed requirements for package to work                       	|
| figure1_plotdata.csv            	| Truth values provided by EDGES experiment 	|
| mc_estimator.py            	| **Main method** for Metropolis and Multiprocessing                   	|
| multiproc.py       	| Methods to handle MPI communication                	|
| MCMC.py 	| Main package for metropolis hastings                     	|
| DataAnalysis.ipynb 	| Jupyter notebook to process the data from multiprocessing Markov Chain MC and to get the plots from data.                     	|
______

### Setup and run ###
1. The main method is in the mc_estimador.py
    
    - install **requirements.txt** to get all packages and dependencies in your local machine.

2. Make sure to set in **mc_estimator.py** the following parameters which are required for the MCMC to run.
Also notice that you will get a folder with plots and data from the estimation process. The folder will be named by the test_to_run constant.

```python
num_samples=20000 #the size of the total Markov Chain
thining=3 #how many steps of the chain are going to be removed
test_to_run ="test_01" #name of the folder for storing the results
```

3. For running the multiprocessing script:

```python
    mpiexec -n 2 python3 mc_estimator.py # -n 2 is the number of processes to use, better if they coincide with the number of cores.
```

4. ***MCMC Module***:
This modules includes all function for sampling, evaluating loglikelihood and the main function for the metropolis hastings algorithm.

The main method is Metropolis.MH()

```python
result,dataframe = Metropolis.MH(sky_model,
                                    parameters,
                                    t_sky_data,
                                    sigma_parameter,
                                    evaluateLogLikelihood,
                                    initial_point,
                                    num_walkers,
                                    rank,
                                    multiprocessing_obj.comm,
                                    size_cores,
                                    sampleBy_processor)  
```

| Propiedades                	| Description                                                            	|
|-----------------------	|------------------------------------------------------------------------	|
| sky_model             	| Function to be evaluated during the MCMC run                           	|
| parameters            	| Dictionary with parameters being tested, with ther min and max values. 	|
| t_sky_data            	| Data loaded from data frame containing truth values.                   	|
| sigma_parameter       	| Sigma value to be used for the loglikelihood evaluation                	|
| evaluateLogLikelihood 	| Function to evaluate loglikelihood every iteration                     	|
| initial_point         	| initial value for the THETA vector. It is a random sample.             	|
| num_walkers           	| Walkers to be used during the run.                                     	|
| rank           	| current rank for the processor in use.                                     	|
| multiprocessing_obj.comm           	| Object for the MPI communication                                     	|
| size_cores          	| Number of cores available                                   	|
| num_samples           	| Samples to be used during run.                                         	|
|                       	|                                                                        	|
____

### Results ###

* You will get multiple outputs.
    
    * A folder  named by test_to_run variable with images generated by the run.
    * Same folder with CSV file containing all data from the run. 

![Scheme](/images/pair_plot_KDE_2d39937df88f1866.png)



